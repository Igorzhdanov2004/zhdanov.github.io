<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ó–∞–ø–∏—Å–∏ v4.0</title>
    <style>
        :root { --p: #4f46e5; --d: #ef4444; --bg: #f3f4f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: #1f2937; padding: 15px; display: flex; justify-content: center; }
        .app-card { width: 100%; max-width: 600px; background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        
        /* Loader */
        #loader { position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 30px; height: 30px; border: 3px solid #e5e7eb; border-top-color: var(--p); border-radius: 50%; animation: s 0.6s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* UI Elements */
        .header { background: #111827; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; background: var(--p); transition: 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-red { background: var(--d); }
        
        input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        
        .grid-ui { display: grid; gap: 20px; }
        .time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin-top: 10px; }
        .t-slot { padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; text-align: center; cursor: pointer; font-size: 14px; }
        .t-slot.busy { background: #fee2e2; color: #991b1b; cursor: not-allowed; border-color: #fca5a5; }
        .t-slot.selected { background: var(--p); color: white; border-color: var(--p); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; font-size: 12px; color: #6b7280; padding-bottom: 8px; border-bottom: 2px solid #f3f4f6; }
        td { padding: 12px 0; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        
        .del-x { color: var(--d); border: 1px solid var(--d); padding: 2px 6px; border-radius: 4px; background: none; cursor: pointer; font-weight: bold; }
        .admin-box { background: #fff7ed; border: 1px dashed #ed8936; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="app-card">
    <div id="loader"><div class="spin"></div><p style="margin-top:10px">–°–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</p></div>

    <div class="header">
        <h2 style="font-size: 18px;">üìÖ Lesson Booking</h2>
        <button onclick="App.sync()" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">üîÑ</button>
    </div>

    <div id="view-login" class="content">
        <label>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</label>
        <input type="text" id="in-name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
        <button class="btn" style="width:100%" onclick="App.login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        <button onclick="localStorage.clear(); location.reload();" style="margin-top:20px; background:none; border:none; color:#9ca3af; width:100%; font-size:12px;">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à (–µ—Å–ª–∏ –Ω–µ –≥—Ä—É–∑–∏—Ç)</button>
    </div>

    <div id="view-main" class="content" style="display:none">
        <div id="admin-tools" style="display:none" class="admin-box">
            <p style="font-size:13px; color:#c2410c; margin-bottom:10px;">‚ö° –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê</p>
            <button class="btn btn-red" style="width:100%; font-size:13px;" onclick="App.clearAll()">–£–¥–∞–ª–∏—Ç—å –í–û–û–ë–©–ï –í–°–ï –∑–∞–ø–∏—Å–∏</button>
        </div>

        <div class="grid-ui">
            <div>
                <label>1. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
                <input type="date" id="in-date" onchange="App.render()">
                
                <label>2. –í—Ä–µ–º—è:</label>
                <div id="time-container" class="time-grid"></div>
                
                <button id="btn-book" class="btn" style="width:100%; margin-top:20px;" onclick="App.book()" disabled>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
            </div>

            <hr style="border:0; border-top:1px solid #eee">

            <div>
                <h4>–ó–∞–ø–∏—Å–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å:</h4>
                <table id="res-table">
                    <thead><tr><th>–í—Ä–µ–º—è</th><th>–£—á–µ–Ω–∏–∫</th><th class="adm-only" style="display:none">–£–¥.</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <button onclick="App.logout()" style="margin-top:30px; width:100%; background:none; border:none; color:#9ca3af; cursor:pointer;">‚Üê –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
</div>

<script>
const CFG = {
    BIN: '698f465fd0ea881f40b7d3e6',
    KEY: '$2a$10$A3hHJ1g7sjF5BuwT2drIKewRvsdMFx0iy8Jn6wpFPse5ciB.bR9n.',
    PASS: 'admin123'
};

const App = {
    db: [],
    user: localStorage.getItem('u_name'),
    isAdmin: localStorage.getItem('u_admin') === 'true',
    selTime: null,

    async init() {
        document.getElementById('in-date').valueAsDate = new Date();
        if (this.user) this.showMain();
        await this.sync();
    },

    async sync() {
        this.toggleL(true);
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN}/latest`, {
                headers: { 'X-Master-Key': CFG.KEY, 'X-Bin-Meta': 'false' }
            });
            if (!res.ok) throw 'Err';
            const data = await res.json();
            this.db = Array.isArray(data) ? data : [];
        } catch (e) {
            console.error("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ");
        }
        this.render();
        this.toggleL(false);
    },

    async save(newDb) {
        this.toggleL(true);
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': CFG.KEY },
                body: JSON.stringify(newDb)
            });
            if (res.ok) {
                this.db = newDb;
                this.render();
            }
        } catch (e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä!");
        }
        this.toggleL(false);
    },

    login() {
        const n = document.getElementById('in-name').value.trim();
        if (!n) return;
        if (n.toLowerCase() === 'admin') {
            if (prompt('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:') !== CFG.PASS) return alert('–ù–µ–≤–µ—Ä–Ω–æ');
            this.isAdmin = true;
        }
        this.user = n;
        localStorage.setItem('u_name', n);
        localStorage.setItem('u_admin', this.isAdmin);
        this.showMain();
    },

    logout() { localStorage.clear(); location.reload(); },

    showMain() {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-main').style.display = 'block';
        if (this.isAdmin) {
            document.getElementById('admin-tools').style.display = 'block';
            document.querySelectorAll('.adm-only').forEach(el => el.style.display = 'table-cell');
        }
    },

    book() {
        const date = document.getElementById('in-date').value;
        const entry = { id: Date.now(), d: date, t: this.selTime, u: this.user };
        const updated = [...this.db, entry];
        this.save(updated);
        this.selTime = null;
    },

    deleteSingle(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å?')) return;
        const updated = this.db.filter(x => x.id !== id);
        this.save(updated);
    },

    clearAll() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —Å–æ—Ç—Ä–µ—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ!')) return;
        this.save([]);
    },

    render() {
        const date = document.getElementById('in-date').value;
        
        // –í—Ä–µ–º—è
        const cont = document.getElementById('time-container');
        cont.innerHTML = '';
        for (let h = 8; h <= 21; h++) {
            const time = `${h}:00`;
            const isBusy = this.db.some(x => x.d === date && x.t === time);
            const d = document.createElement('div');
            d.className = `t-slot ${isBusy ? 'busy' : ''} ${this.selTime === time ? 'selected' : ''}`;
            d.textContent = time;
            if (!isBusy) d.onclick = () => { this.selTime = time; this.render(); };
            cont.appendChild(d);
        }
        document.getElementById('btn-book').disabled = !this.selTime;

        // –¢–∞–±–ª–∏—Ü–∞
        const tbody = document.querySelector('#res-table tbody');
        tbody.innerHTML = '';
        const dayList = this.db.filter(x => x.d === date).sort((a,b) => a.t.localeCompare(b.t));
        
        if(dayList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="color:#999; text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
        }

        dayList.forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><b>${x.t}</b></td><td>${x.u}</td>
            ${this.isAdmin ? `<td><button class="del-x" onclick="App.deleteSingle(${x.id})">√ó</button></td>` : ''}`;
            tbody.appendChild(tr);
        });
    },

    toggleL(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
};

App.init();
</script>

</body>
</html>

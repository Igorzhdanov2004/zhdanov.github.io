–Ø –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ ¬´–∫—Ä–∏–≤–æ–π¬ª —Ä–∞–±–æ—Ç—ã –∏ —Ç–æ–≥–æ, —á—Ç–æ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –∏–ª–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è ‚Äî —ç—Ç–æ **–∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤–µ—Ä—Å–∏–π –¥–∞–Ω–Ω—ã—Ö (Race Condition)** –∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–æ–≤ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ Telegram).

–í —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ, –µ—Å–ª–∏ –¥–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ —Å–∞–π—Ç, –æ–Ω–∏ —Å–∫–∞—á–∏–≤–∞–ª–∏ –æ–¥–Ω—É –∏ —Ç—É –∂–µ –≤–µ—Ä—Å–∏—é. –ö–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è, –æ–Ω –æ–±–Ω–æ–≤–ª—è–ª –±–∞–∑—É. –ö–æ–≥–¥–∞ –≤—Ç–æ—Ä–æ–π –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Å–≤–æ—é *—Å—Ç–∞—Ä—É—é* –≤–µ—Ä—Å–∏—é (–≥–¥–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–µ—Ä–≤–æ–≥–æ) + —Å–≤–æ—é –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å. –í –∏—Ç–æ–≥–µ –∑–∞–ø–∏—Å—å –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–∏—Ä–∞–ª–∞—Å—å.

**–ß—Ç–æ —è –∏—Å–ø—Ä–∞–≤–∏–ª –∏ —É–ª—É—á—à–∏–ª:**

1. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏:** –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (–∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë), —Å–∫—Ä–∏–ø—Ç **—Å–Ω–∞—á–∞–ª–∞ –∑–∞–Ω–æ–≤–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç** –∞–∫—Ç—É–∞–ª—å–Ω—É—é –±–∞–∑—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–Ω–æ –ª–∏ –º–µ—Å—Ç–æ, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç.
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞:** –î–æ–±–∞–≤–∏–ª —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É, —á—Ç–æ–±—ã Telegram –∏ –±—Ä–∞—É–∑–µ—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ.
3. **–ê–¥–º–∏–Ω–∫–∞:** –ò—Å–ø—Ä–∞–≤–∏–ª –ª–æ–≥–∏–∫—É –∫–Ω–æ–ø–∫–∏ ¬´–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë¬ª ‚Äî —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
4. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** –°–¥–µ–ª–∞–ª –¥–∏–∑–∞–π–Ω —á–∏—â–µ, –¥–æ–±–∞–≤–∏–ª –∫–Ω–æ–ø–∫—É —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —á–µ—Ç–∫—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –¥–≤–∞–∂–¥—ã.

–í–æ—Ç –≥–æ—Ç–æ–≤—ã–π, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (–ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞–∫ `.html`):

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìö –ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏—è</title>
    <style>
        :root {
            --bg-body: #121212;
            --bg-container: #ffffff;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background: var(--bg-body);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px 10px;
            color: var(--text-main);
        }

        .container {
            background: var(--bg-container);
            width: 100%;
            max-width: 1000px;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }

        /* --- Header --- */
        .header {
            background: #1f2937;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }

        /* --- Login --- */
        .auth-box {
            padding: 40px 20px;
            text-align: center;
            background: #f9fafb;
        }
        .input-group {
            display: flex;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            color: white;
            background: var(--primary);
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }

        /* --- Main App --- */
        .app-content { display: none; }
        
        .user-bar {
            padding: 15px 20px;
            background: #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .user-info span { font-weight: 700; color: var(--primary); }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        .card {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            background: white;
        }
        .card h3 { margin-bottom: 15px; font-size: 1.1rem; color: #374151; display: flex; align-items: center; gap: 8px; }

        /* --- Date & Time --- */
        .date-picker { width: 100%; margin-bottom: 20px; }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .time-slot {
            padding: 8px 4px;
            text-align: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }
        .time-slot.free:hover { border-color: var(--primary); background: #eef2ff; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .time-slot.busy { background: #fee2e2; color: #991b1b; border-color: #fca5a5; cursor: not-allowed; }
        .time-slot.mine { background: #d1fae5; color: #065f46; border-color: #6ee7b7; cursor: not-allowed; }

        /* --- Slider --- */
        .slider-container { margin: 20px 0; text-align: center; }
        .slider-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: block; margin-top: 5px; }
        input[type=range] { width: 100%; accent-color: var(--primary); }

        /* --- Table --- */
        .table-container {
            margin: 20px;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 600; color: var(--text-muted); }
        td { padding: 12px; border-top: 1px solid var(--border); }
        tr.is-mine { background: #ecfdf5; }
        tr.is-mine td:first-child { border-left: 4px solid var(--success); }

        /* --- Admin --- */
        .admin-panel {
            background: #fff7ed;
            border: 2px dashed #fdba74;
            margin: 20px;
            padding: 20px;
            border-radius: 16px;
            display: none;
        }

        /* --- Loader & Toast --- */
        .loader-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            flex-direction: column;
            gap: 10px;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üìÖ –ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏—è</h1>
        <button class="refresh-btn" onclick="app.loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loaderText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div id="loginScreen" class="auth-box">
        <h2>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è</p>
        <div class="input-group">
            <input type="text" id="usernameInput" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" autocomplete="off">
            <button class="btn" onclick="app.login()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="appContent" class="app-content">
        <div class="user-bar">
            <div class="user-info">–ü—Ä–∏–≤–µ—Ç, <span id="displayUsername"></span>!</div>
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="app.logout()">–í—ã–π—Ç–∏</button>
        </div>

        <div class="grid-layout">
            <div class="card">
                <h3>1. –î–∞—Ç–∞ –∏ –í—Ä–µ–º—è</h3>
                <input type="date" id="dateInput" class="date-picker" onchange="app.renderTimeSlots()">
                
                <div id="timeGrid" class="time-grid">
                    </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h3>2. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                    <div class="slider-container">
                        <span id="durationVal" class="slider-val">60 –º–∏–Ω</span>
                        <input type="range" id="durationInput" min="15" max="180" step="15" value="60" oninput="app.updateDuration()">
                    </div>
                </div>

                <button id="bookBtn" class="btn" style="width: 100%; margin-top: 10px;" onclick="app.bookAppointment()" disabled>
                    –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                </button>
                <p id="selectionSummary" style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: var(--text-muted);"></p>
            </div>

            <div>
                <div id="adminPanel" class="admin-panel">
                    <h3 style="color: #c2410c;">üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                    <p style="margin-bottom: 10px;">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <b id="totalStats">0</b></p>
                    <button class="btn btn-danger" style="width: 100%" onclick="app.clearAllData()">üóë –£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏</button>
                </div>

                <div class="card">
                    <h3>üìã –°–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–ö—Ç–æ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
</div>

<script>
/**
 * –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç JSONBin.io –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.
 * –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç Race Condition (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º).
 */
const CONFIG = {
    BIN_ID: '698f465fd0ea881f40b7d3e6',
    API_KEY: '$2a$10$A3hHJ1g7sjF5BuwT2drIKewRvsdMFx0iy8Jn6wpFPse5ciB.bR9n.',
    ADMIN_PASS: 'admin123' 
};

const app = {
    data: [],
    user: null,
    isAdmin: false,
    selected: { date: null, time: null, duration: 60 },

    init() {
        const savedUser = localStorage.getItem('schedule_user');
        if (savedUser) {
            this.user = savedUser;
            this.isAdmin = localStorage.getItem('schedule_admin') === 'true';
            this.showApp();
        }
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        document.getElementById('dateInput').min = new Date().toISOString().split('T')[0];
        this.loadData();
    },

    // --- API Methods ---
    
    async fetchLatest() {
        try {
            // –î–æ–±–∞–≤–ª—è–µ–º timestamp —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –∫—ç—à Telegram/–ë—Ä–∞—É–∑–µ—Ä–∞
            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest?meta=false&t=${Date.now()}`, {
                headers: { 'X-Master-Key': CONFIG.API_KEY }
            });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            const result = await response.json();
            // JSONBin v3 —Å meta=false –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–∞–∑—É –º–∞—Å—Å–∏–≤ –∏–ª–∏ –æ–±—ä–µ–∫—Ç. 
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π –∏–ª–∏ null, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º []
            return Array.isArray(result) ? result : (result.record || []);
        } catch (e) {
            console.error(e);
            this.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            return [];
        }
    },

    async saveToBin(newData) {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': CONFIG.API_KEY
                },
                body: JSON.stringify(newData)
            });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            return true;
        } catch (e) {
            console.error(e);
            this.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'error');
            return false;
        }
    },

    // --- Core Actions ---

    async loadData() {
        this.toggleLoader(true);
        this.data = await this.fetchLatest();
        this.toggleLoader(false);
        this.renderAll();
    },

    async bookAppointment() {
        if (!this.user || !this.selected.date || !this.selected.time) return;

        this.toggleLoader(true, '–ë—Ä–æ–Ω–∏—Ä—É–µ–º...');

        // 1. –ö–†–ò–¢–ò–ß–ù–û: –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
        const freshData = await this.fetchLatest();
        
        // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –Ω–æ–≤–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è
        const endTime = this.calculateEndTime(this.selected.time, this.selected.duration);

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤ –°–í–ï–ñ–ò–• –¥–∞–Ω–Ω—ã—Ö
        const hasConflict = freshData.some(rec => {
            if (rec.date !== this.selected.date) return false;
            // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
            const recEnd = this.calculateEndTime(rec.time, rec.duration);
            return (this.selected.time < recEnd && endTime > rec.time);
        });

        if (hasConflict) {
            this.toggleLoader(false);
            this.showToast('‚ùå –£–ø—Å! –≠—Ç–æ –≤—Ä–µ–º—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–Ω—è–ª–∏.', 'error');
            this.data = freshData; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            this.renderAll(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —á—Ç–æ–±—ã —é–∑–µ—Ä —É–≤–∏–¥–µ–ª –∑–∞–Ω—è—Ç–æ–µ
            return;
        }

        // 4. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
        const newRecord = {
            id: Date.now().toString(),
            date: this.selected.date,
            time: this.selected.time,
            duration: this.selected.duration,
            student: this.user,
            created: new Date().toISOString()
        };

        freshData.push(newRecord);

        // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
        const saved = await this.saveToBin(freshData);
        
        if (saved) {
            this.data = freshData;
            this.selected.time = null; // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
            this.showToast('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!', 'success');
            this.renderAll();
        }
        
        this.toggleLoader(false);
    },

    async clearAllData() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ —É –í–°–ï–• —É—á–µ–Ω–∏–∫–æ–≤.')) return;
        
        this.toggleLoader(true, '–£–¥–∞–ª–µ–Ω–∏–µ...');
        // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
        const saved = await this.saveToBin([]);
        if (saved) {
            this.data = [];
            this.showToast('–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
            this.renderAll();
        }
        this.toggleLoader(false);
    },

    // --- UI Logic ---

    login() {
        const val = document.getElementById('usernameInput').value.trim();
        if (!val) return this.showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
        if (val.toLowerCase() === 'admin') {
            const pass = prompt('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
            if (pass !== CONFIG.ADMIN_PASS) return this.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
            this.isAdmin = true;
            localStorage.setItem('schedule_admin', 'true');
        } else {
            this.isAdmin = false;
            localStorage.removeItem('schedule_admin');
        }

        this.user = val;
        localStorage.setItem('schedule_user', this.user);
        this.showApp();
    },

    logout() {
        this.user = null;
        this.isAdmin = false;
        localStorage.removeItem('schedule_user');
        localStorage.removeItem('schedule_admin');
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('appContent').style.display = 'none';
        document.getElementById('usernameInput').value = '';
    },

    showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        document.getElementById('displayUsername').textContent = this.user + (this.isAdmin ? ' (Admin)' : '');
        document.getElementById('adminPanel').style.display = this.isAdmin ? 'block' : 'none';
        this.renderAll();
    },

    updateDuration() {
        const val = document.getElementById('durationInput').value;
        this.selected.duration = parseInt(val);
        document.getElementById('durationVal').textContent = val + ' –º–∏–Ω';
        this.updateSummary();
        this.renderTimeSlots(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å –Ω–æ–≤–æ–π –¥–ª–∏–Ω–æ–π
    },

    calculateEndTime(startTime, durationMins) {
        const [h, m] = startTime.split(':').map(Number);
        const totalMins = h * 60 + m + durationMins;
        const newH = Math.floor(totalMins / 60) % 24;
        const newM = totalMins % 60;
        return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
    },

    // --- Rendering ---

    renderAll() {
        this.renderTimeSlots();
        this.renderTable();
        this.updateStats();
    },

    renderTimeSlots() {
        const container = document.getElementById('timeGrid');
        const dateVal = document.getElementById('dateInput').value;
        this.selected.date = dateVal;
        
        container.innerHTML = '';
        document.getElementById('bookBtn').disabled = true;
        this.updateSummary();

        if (!dateVal) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</div>';
            return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã —Å 08:00 –¥–æ 22:00 –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω
        const startHour = 8;
        const endHour = 22;

        for (let h = startHour; h < endHour; h++) {
            for (let m = 0; m < 60; m += 15) {
                const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = 'time-slot';
                el.textContent = timeStr;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
                const myEndTime = this.calculateEndTime(timeStr, this.selected.duration);
                
                const conflict = this.data.find(r => {
                    if (r.date !== dateVal) return false;
                    const rEnd = this.calculateEndTime(r.time, r.duration);
                    // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: (StartA < EndB) and (EndA > StartB)
                    return (timeStr < rEnd && myEndTime > r.time);
                });

                if (conflict) {
                    if (conflict.student === this.user) {
                        el.classList.add('mine');
                        el.title = "–í–∞—à–∞ –∑–∞–ø–∏—Å—å";
                    } else {
                        el.classList.add('busy');
                        el.title = `–ó–∞–Ω—è—Ç–æ: ${conflict.student}`;
                    }
                } else {
                    el.classList.add('free');
                    el.onclick = () => this.selectTime(timeStr, el);
                    if (this.selected.time === timeStr) el.classList.add('selected');
                }

                container.appendChild(el);
            }
        }
    },

    selectTime(time, el) {
        // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö
        document.querySelectorAll('.time-slot.selected').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        this.selected.time = time;
        document.getElementById('bookBtn').disabled = false;
        this.updateSummary();
    },

    updateSummary() {
        const el = document.getElementById('selectionSummary');
        if (this.selected.date && this.selected.time) {
            const endT = this.calculateEndTime(this.selected.time, this.selected.duration);
            el.innerHTML = `–ë—É–¥–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ:<br><b>${this.selected.date}</b> —Å <b>${this.selected.time}</b> –¥–æ <b>${endT}</b>`;
        } else {
            el.textContent = '';
        }
    },

    renderTable() {
        const tbody = document.querySelector('#scheduleTable tbody');
        tbody.innerHTML = '';

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –¥–∞—Ç–∞, –ø–æ—Ç–æ–º –≤—Ä–µ–º—è
        const sorted = [...this.data].sort((a, b) => {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            return a.time.localeCompare(b.time);
        });

        if (sorted.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px; color:#888;">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç</td></tr>';
            return;
        }

        sorted.forEach(rec => {
            const tr = document.createElement('tr');
            if (rec.student === this.user) tr.className = 'is-mine';
            
            const endT = this.calculateEndTime(rec.time, rec.duration);
            
            tr.innerHTML = `
                <td>${rec.date}</td>
                <td>${rec.time} - ${endT}</td>
                <td>${rec.student}</td>
            `;
            tbody.appendChild(tr);
        });
    },

    updateStats() {
        if (this.isAdmin) {
            document.getElementById('totalStats').textContent = this.data.length;
        }
    },

    toggleLoader(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        const l = document.getElementById('loader');
        if (show) {
            document.getElementById('loaderText').textContent = text;
            l.style.display = 'flex';
        } else {
            l.style.display = 'none';
        }
    },

    showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast ${type}`;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }
};

// –ó–∞–ø—É—Å–∫
app.init();
</script>

</body>
</html>

